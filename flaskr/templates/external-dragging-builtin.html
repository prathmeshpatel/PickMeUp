<!DOCTYPE html>
<html>
<head>
<meta charset='utf-8' />
<link href='static/packages/core/main.css' rel='stylesheet' />
<link href='static/packages/daygrid/main.css' rel='stylesheet' />
<link href='static/packages/timegrid/main.css' rel='stylesheet' />
<script src='static/packages/core/main.js'></script>
<script src='static/packages/interaction/main.js'></script>
<script src='static/packages/daygrid/main.js'></script>
<script src='static/packages/timegrid/main.js'></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.min.js"></script>
<script src="https://unpkg.com/tooltip.js"></script>
<script>
  var quality = 1;
  var g_type = null;
  var g_info = null;
  var g_date = null;

  function open_form(type, date, info) {
    document.getElementById("myForm").style.display = "block";
    g_type = type;
    g_date = date;
    g_info = info;
    // console.log(type);
    // console.log(info);
  }
  function submit_form() {
    document.getElementById("myForm").style.display = "none";
    quality = document.getElementById('quality').value;
    // console.log(quality);
    // console.log(g_type);
    // console.log(g_info);
    ajax_other(quality);
  }
  function ajax_other(quality) {
    // console.log("Quality: " + quality);
    // console.log(g_info.event.start.toUTCString());
    var end = new Date(g_info.event.start.toUTCString());
    end.setHours(end.getHours() + 1);
    var n = end.toISOString();
    var start = new Date(g_info.event.start.toUTCString());
    var s = start.toISOString();    
    return $.ajax({
      data: {
        'id': g_type,
        'date': g_date,
        'start_time': s,
        'end_time': n,
        'quality': quality, 
      },
      type: 'POST',
      url: "{{url_for('add_entry')}}"
    });
  }
  document.addEventListener('DOMContentLoaded', function() {
    var Calendar = FullCalendar.Calendar;
    var Draggable = FullCalendarInteraction.Draggable
    function handleForm(event) { 
      event.preventDefault(); 
    } 
    document.getElementById("myForm").addEventListener('submit', handleForm);
    /* initialize the external events
    -----------------------------------------------------------------*/

    var containerEl = document.getElementById('external-events-list');
    new Draggable(containerEl, {
      itemSelector: '.fc-event',
      eventData: function(eventEl) {
        return {
          title: eventEl.innerText.trim()
        }
      }
    });

    /* initialize the calendar
    -----------------------------------------------------------------*/

    var calendarEl = document.getElementById('calendar');
    var calendar = new Calendar(calendarEl, {
      events: function(start, end, timezone, callback){
        return $.ajax({
              url: '/values',
              type: 'GET',
              dataType: 'json',
              data: {
                  start: '2018-12-01T08:00:00',
                  end: '2020-12-05T08:00:00',
              },
              success: function(result) {
      //             var events = [];
      //             console.log(result);
      //             result.forEach(function(obj) {
      //                 console.log(obj);
      //                 events.push({
      //                     title: obj.title,
      //                     start: new Date(obj.start).toISOString().substring(0, new Date(obj.start).toISOString().length - 1),
      //                     end: new Date(obj.end).toISOString().substring(0, new Date(obj.end).toISOString().length - 1)
      //                 });
                      // console.log(events);
      //             });
      //             callback(events);
              }
          });
      },
      plugins: [ 'interaction', 'dayGrid', 'timeGrid'],
      header: {
        left: 'prev,next today',
        center: 'title',
        right: 'dayGridMonth,timeGridWeek,timeGridDay'
      },
      editable: true,
      droppable: true, // this allows things to be dropped onto the calendar
      eventDragStart: function(info){ // When begin dragging an element, delete that row from the database - OCCURS WHEN DRAG EVENT ON CALENDAR TO NEW LOCATION
        var type = info.event.title
        var date = info.event.start.getUTCFullYear() + "-" + (info.event.start.getUTCMonth() + 1) + "-" + info.event.start.getUTCDate();
        var start_time = new Date(info.event.start.toUTCString());
        var s = start_time.toISOString();    
        console.log(s);
        console.log(type);
        $.ajax({
          data: {
            'id': type,
            'date': date,
            'start_time': s,
          },
          type: 'POST',
          url: "{{url_for('delete_entry')}}"
        });
      },
      eventDrop: function(info) {
        console.log(info.event.title)
        var type = info.event.title;;
        var date = info.event.start.getUTCFullYear() + "-" + (info.event.start.getUTCMonth()+1) + "-" + info.event.start.getUTCDate();
        console.log("drop");  
        console.log(type);
        if (type == "Mood") {
          var emojis = ['😥','😥','😕','😐','😌','😊'];  // emoji index maps to happiness 1-5, index 0 placeholder
          // console.log(emojis);
          var index = emojis.indexOf(info.event.title); // 1
          // console.log(index);
          $.ajax({
            data: {
              'id': type,
              'date': date,
              'happiness': index,
            },
            type: 'POST',
            url: "{{url_for('add_entry')}}"
          });
        } else {
          open_form(type, date, info);
        }
      },
      eventReceive: function(info) {
        var type = info.draggedEl.getAttribute("id");
        var date = info.event.start.getUTCFullYear() + "-" + (info.event.start.getUTCMonth()+1) + "-" + info.event.start.getUTCDate();
        var duration = 1;
        // console.log(info.event.start);
        // console.log(type);
        if (type == "Mood") {
          var emojis = ['😥','😥','😕','😐','😌','😊'];  // emoji index maps to happiness 1-5, index 0 placeholder
          // console.log(emojis);
          var index = emojis.indexOf(info.event.title); // 1
          // console.log(index);
          $.ajax({
            data: {
              'id': type,
              'date': date,
              'happiness': index,
            },
            type: 'POST',
            url: "{{url_for('add_entry')}}"
          });
        } else {
          open_form(type, date, info);
        }
      },
      eventResize: function(info) {
        var date = info.event.start.getUTCFullYear() + "-" + (info.event.start.getUTCMonth()+1) + "-" + info.event.start.getUTCDate();
        var type = info.event.title;
        $.ajax({
          data: {
            'id': type,
            'date': date,
            'start_time': info.event.start,
            'end_time': info.event.end,
          },
          type: 'POST',
          url: "{{url_for('entry_resize')}}"
        });
      }
    });
    calendar.render();
  });

</script>
<style>
  body {
    margin-top: 10px;
    font-size: 14px;
    font-family: Arial, Helvetica Neue, Helvetica, sans-serif;
  }
  /* Add styles to the form container */
  .form-container {
    max-width: 300px;
    padding: 10px;
    background-color: white;
  }
  /* Button used to open the contact form - fixed at the bottom of the page */
  .open-button {
    background-color: #555;
    color: white;
    padding: 16px 20px;
    border: none;
    cursor: pointer;
    opacity: 0.8;
    position: fixed;
    bottom: 23px;
    right: 28px;
    width: 280px;
  }
    /* The popup form - hidden by default */
  .form-popup {
    background: rgba(100, 100, 100, 0.15) !important;
    display: none;
    position: fixed;
    bottom: 0;
    right: 15px;
    border: 3px solid #f1f1f1;
    z-index: 9;
  }

  /* Full-width input fields */
  .form-container input[type=integer], .form-container {
    width: 100%;
    padding: 15px;
    margin: 5px 0 22px 0;
    border: none;
    background: #f1f1f1;
  }
  /* When the inputs get focus, do something */
  .form-container input[type=text]:focus, .form-container input[type=password]:focus {
    background-color: #ddd;
    outline: none;
  }
  /* Set a style for the submit/login button */
  .form-container .btn {
    background-color: #4CAF50;
    color: white;
    padding: 16px 20px;
    border: none;
    cursor: pointer;
    width: 100%;
    margin-bottom:10px;
    opacity: 0.8;
  }
  /* Add a red background color to the cancel button */
  .form-container .cancel {
    background-color: red;
  }
  /* Add some hover effects to buttons */
  .form-container .btn:hover, .open-button:hover {
    opacity: 1;
  }
  .modal-body .form-horizontal .col-sm-2,
  .modal-body .form-horizontal .col-sm-10 {
      width: 100%
  }

  .modal-body .form-horizontal .control-label {
      text-align: left;
  }
  .modal-body .form-horizontal .col-sm-offset-2 {
      margin-left: 15px;
  }
  #logo-circle{
      height: 80px;
      width: 230px;
      float: left;
      margin-left: 0px;
  }
  #wrap {
    width: 1100px;
    margin: 0 auto;
  }
  #external-events {
    margin-top: 5%;
    float: left;
    width: 150px;
    padding: 0 10px;
    border: 1px solid #ccc;
    background: #eee;
    text-align: left;
  }
  #external-events h4 {
    font-size: 16px;
    margin-top: 0;
    padding-top: 1em;
  }
  #external-events .fc-event {
    margin: 10px 0;
    cursor: pointer;
  }
  #external-events p {
    margin: 1.5em 0;
    font-size: 11px;
    color: #666;
  }
  #external-events p input {
    margin: 0;
    vertical-align: middle;
  }
  #calendar {
    margin-top: 0px;
    float: right;
    width: 900px;
  }

</style>
</head>
<body>

  <div id='wrap'>
    <div id="logo-circle">
      <img src="../images/logo-1.svg" alt="Logo">
    </div>
    <div id='calendar'></div>
    <div class="form-popup" id="myForm">
      <form class="form-container">
        <h1>Quality</h1>
        <label for="email"><b>Rate quality of activity from 1 to 5!</b></label>
        <input id="quality" type="number" min=1 max=5 required>
        <button id="quality_button" type="submit" onclick="submit_form();" class="btn">Submit</button>
        <button type="button" class="btn cancel" onclick="closeForm()">Close</button>
      </form>
    </div>
    <div id='external-events'>
      <h4>Log your day!</h4>
      <div id='external-events-list'>-
        <div class='fc-event' id='Sleep'>Sleep</div>
        <div class='fc-event' id='Exercise'>Exercise</div>
        <div class='fc-event' id='Work'>Work</div>
        <div class='fc-event' id='Meals'>Meals</div>
        <div class='fc-event' id='Social'>Social</div>
        <div class='fc-event' id='Downtime'>Downtime</div>
      <p>
        <h4>Log your mood!</h4>
          <div class='fc-event' id='Mood'>😊</div>
          <div class='fc-event' id='Mood'>😌 </div>
          <div class='fc-event' id='Mood'>😐</div>
          <div class='fc-event' id='Mood'>😕</div>
          <div class='fc-event' id='Mood'>😥 </div>
        <h4>Visualize Trends!</h4>
            <form action="/monthlytrends">
              <input type="submit" value="Monthly Trends" />
            </form>
            <form action="/weeklytrends">
              <input type="submit" value="Weekly Trends" />
            </form>
            <form action="/dailytrends">
              <input type="submit" value="Daily Trends" />
            </form>
      </div>
    </p>
  </div>
    <div style='clear:both'></div>
  </div>
</body>
</html>
